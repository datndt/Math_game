<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMO Exam Simulator v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Times+New+Roman&display=swap');
        
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f1f5f9;
            user-select: none;
        }

        /* --- STYLES CHO M√ÄN H√åNH CH√ÄO (START SCREEN) --- */
        .start-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .setting-group label {
            display: block;
            font-weight: 700;
            color: #475569;
            margin-bottom: 0.5rem;
        }

        .setting-select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid #cbd5e1;
            font-weight: 600;
            color: #334155;
            background-color: #f8fafc;
            outline: none;
            transition: border-color 0.2s;
        }
        .setting-select:focus {
            border-color: #3b82f6;
        }

        .start-btn {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            font-weight: 800;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            width: 100%;
            font-size: 1.125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .start-btn:active {
            transform: scale(0.98);
            box-shadow: none;
        }

        /* --- STYLES CHO ƒê·ªÄ THI (EXAM PAPER) --- */
        .exam-paper {
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
        }

        .question-text {
            font-family: 'Times New Roman', serif;
            font-size: 1.25rem;
            line-height: 1.6;
        }

        /* Option Card */
        .option-card {
            transition: all 0.2s;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            background: white;
        }
        .option-card:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: translateY(-3px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .option-card.selected-correct {
            background-color: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #15803d;
        }
        .option-card.selected-wrong {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #b91c1c;
            animation: shake 0.4s;
        }

        canvas {
            image-rendering: pixelated;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="start-screen" class="start-card w-full max-w-md p-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-900 mb-2">TIMO EXAM</h1>
            <p class="text-slate-500 font-semibold uppercase tracking-widest text-sm">Logical Thinking Simulation</p>
        </div>

        <div class="space-y-6">
            <div class="setting-group">
                <label>Difficulty (ƒê·ªô kh√≥):</label>
                <select id="difficulty-select" class="setting-select">
                    <option value="easy">Easy (D·ªÖ - Pattern A-B, A-B-C)</option>
                    <option value="medium" selected>Medium (V·ª´a - A-A-B, A-B-C-D)</option>
                    <option value="hard">Hard (Kh√≥ - Xen k·∫Ω, ƒê·ªëi x·ª©ng)</option>
                </select>
            </div>

            <div class="setting-group">
                <label>Questions (S·ªë c√¢u h·ªèi):</label>
                <select id="q-count-select" class="setting-select">
                    <option value="5">5 Questions (Quick Test)</option>
                    <option value="10" selected>10 Questions (Standard)</option>
                    <option value="15">15 Questions (Challenge)</option>
                    <option value="20">20 Questions (Marathon)</option>
                </select>
            </div>

            <button onclick="Game.startExam()" class="start-btn mt-4">
                Start Exam ‚ûú
            </button>
        </div>
    </div>

    <div id="game-screen" class="exam-paper w-full max-w-5xl rounded-xl p-6 md:p-10 relative hidden">
        
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
            <div>
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Question</span>
                <div class="text-3xl font-black text-blue-900"><span id="current-q-num">1</span><span class="text-lg text-slate-400 font-medium">/<span id="total-q-num">10</span></span></div>
            </div>
            <div class="text-right">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Score</span>
                <div class="text-3xl font-black text-green-600" id="current-score">0</div>
            </div>
        </div>

        <div id="game-container">
            <div class="mb-8">
                <div class="question-text text-slate-800">
                    <p class="mb-1 font-semibold">20. By observing the pattern shown below, what is the figure in the space provided?</p>
                    <p class="italic text-slate-600">D·ª±a v√†o quy lu·∫≠t d∆∞·ªõi ƒë√¢y, t√¨m h√¨nh v·∫Ω th√≠ch h·ª£p ƒë·ªÉ ƒëi·ªÅn v√†o ch·ªó tr·ªëng.</p>
                </div>
            </div>

            <div class="flex justify-center mb-10 overflow-x-auto py-4 bg-slate-50 rounded-lg border border-slate-200">
                <canvas id="patternCanvas" height="100"></canvas>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="options-grid">
                </div>

            <div id="feedback" class="hidden text-center p-4 rounded-lg bg-slate-100 mb-6 border-l-4">
                <p id="feedback-text" class="text-lg font-bold"></p>
            </div>

            <div class="flex justify-between items-center mt-8 pt-6 border-t border-slate-100">
                <button onclick="Game.quitExam()" class="text-slate-400 hover:text-red-500 font-bold text-sm transition-colors">
                    ‚úï Quit Exam
                </button>
                <button id="next-btn" onclick="Game.nextQuestion()" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-colors">
                    Next Question ‚ûú
                </button>
            </div>
        </div>

        <div id="end-screen" class="hidden text-center py-10">
            <div class="text-6xl mb-6">üèÜ</div>
            <h2 class="text-4xl font-extrabold text-slate-800 mb-3">Exam Completed!</h2>
            <p class="text-slate-600 mb-8 text-lg">B·∫°n ƒë√£ ho√†n th√†nh b√†i thi.</p>
            
            <div class="inline-block bg-blue-50 px-8 py-4 rounded-2xl border border-blue-100 mb-10">
                <div class="text-sm font-bold text-blue-400 uppercase tracking-widest mb-1">Final Score</div>
                <div class="text-5xl font-black text-blue-900"><span id="final-score">0</span><span class="text-2xl text-blue-300">/<span id="final-total">10</span></span></div>
            </div>

            <div>
                <button onclick="location.reload()" class="bg-slate-800 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-slate-900 transition-transform active:scale-95">
                    Back to Home (Quay l·∫°i)
                </button>
            </div>
        </div>

    </div>

<script>
    /**
     * H·ªÜ TH·ªêNG V·∫º H√åNH H·ªåC (SHAPE DRAWER)
     * V·∫Ω h√¨nh ƒëen tr·∫Øng chu·∫©n ƒë·ªÅ thi TIMO.
     */
    const ShapeDrawer = {
        draw: function(ctx, shapeType, x, y, size) {
            ctx.fillStyle = 'black';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2.5; // N√©t d√†y h∆°n m·ªôt ch√∫t cho r√µ
            
            ctx.beginPath();
            switch(shapeType) {
                case 'circle': // H√¨nh tr√≤n ƒëen
                    ctx.arc(x, y, size/2, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'square': // H√¨nh vu√¥ng ƒëen
                    ctx.rect(x - size/2, y - size/2, size, size);
                    ctx.fill();
                    break;
                case 'triangle': // Tam gi√°c ƒë·ªÅu ƒëen
                    this.drawPolygon(ctx, x, y, size/1.8, 3, -Math.PI/2);
                    ctx.fill();
                    break;
                case 'inverted_triangle': // Tam gi√°c ng∆∞·ª£c ƒëen (nh∆∞ trong ·∫£nh 2aa740)
                    this.drawPolygon(ctx, x, y, size/1.8, 3, Math.PI/2);
                    ctx.fill(); // Trong ·∫£nh l√† r·ªóng (tr·∫Øng), nh∆∞ng ƒë·ªÉ chu·∫©n h√≥a ta fill ƒëen tr∆∞·ªõc, n·∫øu c·∫ßn r·ªóng th√¨ d√πng type kh√°c.
                    break;
                case 'star': // Ng√¥i sao ƒëen
                    this.drawStar(ctx, x, y, 5, size/2, size/4);
                    ctx.fill();
                    break;
                
                // --- C√ÅC H√åNH R·ªñNG (Outline) ---
                case 'empty_square': 
                    ctx.rect(x - size/2, y - size/2, size, size);
                    ctx.stroke();
                    break;
                case 'empty_triangle':
                    this.drawPolygon(ctx, x, y, size/1.8, 3, -Math.PI/2);
                    ctx.stroke();
                    break;
                case 'empty_inverted_triangle': // Tam gi√°c ng∆∞·ª£c r·ªóng (nh∆∞ ·∫£nh 2aa740)
                    this.drawPolygon(ctx, x, y, size/1.8, 3, Math.PI/2);
                    ctx.stroke();
                    break;
                
                // --- D·∫§U H·ªéI ---
                case 'question_mark': 
                    ctx.moveTo(x - size/1.5, y + size/2 + 5);
                    ctx.lineTo(x + size/1.5, y + size/2 + 5);
                    ctx.stroke();
                    ctx.font = `bold ${size}px serif`;
                    ctx.fillStyle = 'black';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('?', x, y - 5);
                    break;
            }
        },

        drawPolygon: function(ctx, x, y, radius, sides, rotateAngle) {
            ctx.moveTo(x + radius * Math.cos(rotateAngle), y + radius * Math.sin(rotateAngle));
            for (let i = 1; i <= sides; i++) {
                ctx.lineTo(x + radius * Math.cos(rotateAngle + i * 2 * Math.PI / sides), y + radius * Math.sin(rotateAngle + i * 2 * Math.PI / sides));
            }
        },

        drawStar: function(ctx, cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let x = cx;
            let y = cy;
            let step = Math.PI / spikes;
            ctx.moveTo(cx, cy - outerRadius);
            for (let i = 0; i < spikes; i++) {
                x = cx + Math.cos(rot) * outerRadius;
                y = cy + Math.sin(rot) * outerRadius;
                ctx.lineTo(x, y);
                rot += step;
                x = cx + Math.cos(rot) * innerRadius;
                y = cy + Math.sin(rot) * innerRadius;
                ctx.lineTo(x, y);
                rot += step;
            }
            ctx.lineTo(cx, cy - outerRadius);
        }
    };

    /**
     * LOGIC TR√í CH∆†I
     */
    const Game = {
        canvas: document.getElementById('patternCanvas'),
        ctx: null,
        
        // Kho h√¨nh ·∫£nh d√πng ƒë·ªÉ sinh ƒë·ªÅ
        shapesPool: [
            'circle', 'square', 'triangle', 'star', 
            'inverted_triangle', 'empty_square', 'empty_triangle', 'empty_inverted_triangle'
        ],

        // C√†i ƒë·∫∑t game
        settings: {
            difficulty: 'medium',
            totalQuestions: 10
        },

        state: {
            currentQuestion: 0,
            score: 0,
            isAnswered: false,
            currentData: null
        },

        // --- C√ÅC M·∫™U QUY LU·∫¨T (PATTERNS) ---
        // S·ªë ƒë·∫°i di·ªán cho index c·ªßa h√¨nh trong m·∫£ng shapes ƒë∆∞·ª£c ch·ªçn
        patterns: {
            easy: [
                { type: 'AB', seq: [0, 1, 0, 1, 0, 1, 0, 1] }, // A B A B...
                { type: 'ABC', seq: [0, 1, 2, 0, 1, 2, 0, 1, 2] }, // A B C A B C...
                { type: 'AAB', seq: [0, 0, 1, 0, 0, 1, 0, 0] } // A A B A A B...
            ],
            medium: [
                { type: 'AABB', seq: [0, 0, 1, 1, 0, 0, 1, 1] }, // A A B B...
                { type: 'ABCD', seq: [0, 1, 2, 3, 0, 1, 2, 3] }, // A B C D... (nh∆∞ ·∫£nh 2aa740)
                { type: 'ABCC', seq: [0, 1, 2, 2, 0, 1, 2, 2] }, // A B C C... (nh∆∞ ·∫£nh 2aa3f4)
                { type: 'AABC', seq: [0, 0, 1, 2, 0, 0, 1, 2] } // A A B C... (nh∆∞ ·∫£nh 2aa79d)
            ],
            hard: [
                { type: 'Sandwich', seq: [0, 1, 0, 2, 0, 1, 0, 2] }, // A B A C... (Xen k·∫Ω)
                { type: 'Mirror', seq: [0, 1, 2, 2, 1, 0, 0, 1] }, // A B C C B A...
                { type: 'Growing', seq: [0, 1, 0, 1, 1, 0, 1, 1, 1] } // A B A B B A B B B (Kh√≥)
            ]
        },

        // 1. Kh·ªüi ƒë·ªông t·ª´ m√†n h√¨nh Start
        startExam: function() {
            // L·∫•y c√†i ƒë·∫∑t t·ª´ UI
            this.settings.difficulty = document.getElementById('difficulty-select').value;
            this.settings.totalQuestions = parseInt(document.getElementById('q-count-select').value);

            // Reset tr·∫°ng th√°i
            this.state.currentQuestion = 0;
            this.state.score = 0;
            this.ctx = this.canvas.getContext('2d');

            // C·∫≠p nh·∫≠t UI t·ªïng quan
            document.getElementById('total-q-num').innerText = this.settings.totalQuestions;
            document.getElementById('final-total').innerText = this.settings.totalQuestions;
            document.getElementById('current-score').innerText = 0;

            // Chuy·ªÉn m√†n h√¨nh
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('block');

            this.nextQuestion();
        },

        quitExam: function() {
            if(confirm("Are you sure you want to quit? (B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t?)")) {
                location.reload();
            }
        },

        // 2. Logic sinh c√¢u h·ªèi
        generateQuestionData: function() {
            // 2a. Ch·ªçn Pattern d·ª±a tr√™n ƒë·ªô kh√≥
            let availablePatterns = this.patterns[this.settings.difficulty];
            // N·∫øu kh√¥ng ƒë·ªß pattern (tr√°nh l·ªói), fallback v·ªÅ easy
            if (!availablePatterns) availablePatterns = this.patterns['easy'];
            
            const selectedPatternTemplate = availablePatterns[Math.floor(Math.random() * availablePatterns.length)];
            
            // 2b. X√°c ƒë·ªãnh c·∫ßn bao nhi√™u h√¨nh kh√°c nhau (max index trong seq + 1)
            const uniqueShapesNeeded = Math.max(...selectedPatternTemplate.seq) + 1;

            // 2c. L·∫•y ng·∫´u nhi√™n c√°c h√¨nh t·ª´ Shapes Pool
            const shuffledPool = this.shuffle([...this.shapesPool]);
            const selectedShapes = shuffledPool.slice(0, uniqueShapesNeeded);

            // 2d. T·∫°o chu·ªói h√¨nh ƒë·∫ßy ƒë·ªß (Map t·ª´ s·ªë sang h√¨nh)
            // V√≠ d·ª• seq: [0, 1, 0] -> shapes: [Square, Circle] -> Result: [Square, Circle, Square]
            const fullSequence = selectedPatternTemplate.seq.map(idx => selectedShapes[idx]);

            // 2e. Ch·ªçn v·ªã tr√≠ √¥ tr·ªëng (th∆∞·ªùng l√† cu·ªëi ho·∫∑c g·∫ßn cu·ªëi)
            let blankIndex = fullSequence.length - 1; // M·∫∑c ƒë·ªãnh cu·ªëi
            if (this.settings.difficulty === 'hard') {
                // Kh√≥ th√¨ c√≥ th·ªÉ tr·ªëng ·ªü gi·ªØa
                blankIndex = Math.floor(Math.random() * 2) + (fullSequence.length - 3); 
            }
            
            const correctAnswer = fullSequence[blankIndex];
            
            // Chu·ªói hi·ªÉn th·ªã (c√≥ d·∫•u h·ªèi)
            const displaySequence = [...fullSequence];
            displaySequence[blankIndex] = 'question_mark';

            // 2f. T·∫°o Options (1 ƒë√∫ng + 3 sai)
            let options = [correctAnswer];
            const wrongOptions = this.shapesPool.filter(s => s !== correctAnswer);
            this.shuffle(wrongOptions);
            options.push(wrongOptions[0], wrongOptions[1], wrongOptions[2]);
            this.shuffle(options);

            return {
                sequence: displaySequence,
                options: options,
                correct: correctAnswer,
                blankIndex: blankIndex
            };
        },

        // 3. Chuy·ªÉn c√¢u h·ªèi
        nextQuestion: function() {
            // Ki·ªÉm tra k·∫øt th√∫c
            if (this.state.currentQuestion >= this.settings.totalQuestions) {
                this.endGame();
                return;
            }

            this.state.currentQuestion++;
            this.state.isAnswered = false;

            // Reset UI c√¢u h·ªèi
            document.getElementById('current-q-num').innerText = this.state.currentQuestion;
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            
            // X√≥a style c≈© c·ªßa feedback
            document.getElementById('feedback').classList.remove('border-green-500', 'border-red-500', 'bg-green-50', 'bg-red-50');

            // Sinh d·ªØ li·ªáu m·ªõi
            this.state.currentData = this.generateQuestionData();

            // V·∫Ω Canvas
            this.drawSequence(this.state.currentData.sequence);

            // Render Options
            this.renderOptions(this.state.currentData.options);
        },

        // 4. V·∫Ω chu·ªói h√¨nh l√™n Canvas
        drawSequence: function(sequence) {
            const itemSize = 40;
            const gap = 35;
            const totalWidth = sequence.length * itemSize + (sequence.length - 1) * gap;
            
            // Resize canvas
            this.canvas.width = Math.max(800, totalWidth + 100);
            this.canvas.height = 100;
            
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

            // CƒÉn gi·ªØa
            let startX = (this.canvas.width - totalWidth) / 2 + itemSize/2;
            const centerY = this.canvas.height / 2;

            sequence.forEach((shape, index) => {
                ShapeDrawer.draw(this.ctx, shape, startX + index * (itemSize + gap), centerY, itemSize);
            });
        },

        // 5. Render n√∫t ch·ªçn ƒë√°p √°n
        renderOptions: function(options) {
            const container = document.getElementById('options-grid');
            container.innerHTML = '';

            options.forEach((shape, index) => {
                const btn = document.createElement('div');
                btn.className = 'option-card h-28 flex flex-col items-center justify-center relative';
                
                // Nh√£n A, B, C, D
                const label = document.createElement('span');
                label.className = 'absolute top-2 left-3 font-bold text-slate-400 text-sm';
                label.innerText = String.fromCharCode(65 + index) + ".";
                btn.appendChild(label);

                // Canvas con
                const optCanvas = document.createElement('canvas');
                optCanvas.width = 60;
                optCanvas.height = 60;
                const optCtx = optCanvas.getContext('2d');
                ShapeDrawer.draw(optCtx, shape, 30, 30, 30);
                
                btn.appendChild(optCanvas);
                
                // S·ª± ki·ªán click
                btn.onclick = () => this.checkAnswer(shape, btn);
                container.appendChild(btn);
            });
        },

        // 6. Ki·ªÉm tra ƒë√°p √°n
        checkAnswer: function(selectedShape, btnElement) {
            if (this.state.isAnswered) return;
            this.state.isAnswered = true;

            const isCorrect = selectedShape === this.state.currentData.correct;
            const feedbackEl = document.getElementById('feedback');
            const feedbackText = document.getElementById('feedback-text');

            if (isCorrect) {
                this.state.score++;
                document.getElementById('current-score').innerText = this.state.score;
                
                btnElement.classList.add('selected-correct');
                feedbackEl.className = "text-center p-4 rounded-lg mb-6 border-l-4 border-green-500 bg-green-50";
                feedbackText.innerHTML = "<span class='text-green-700'>Correct! (Ch√≠nh x√°c)</span>";

                // V·∫Ω ƒë√® h√¨nh ƒë√∫ng v√†o ch·ªó d·∫•u h·ªèi
                this.revealCorrectAnswer(selectedShape);

            } else {
                btnElement.classList.add('selected-wrong');
                feedbackEl.className = "text-center p-4 rounded-lg mb-6 border-l-4 border-red-500 bg-red-50";
                feedbackText.innerHTML = "<span class='text-red-700'>Wrong! (Sai r·ªìi)</span>";
                
                // Highlight ƒë√°p √°n ƒë√∫ng (t√πy ch·ªçn)
                // this.revealCorrectOption(); 
            }

            feedbackEl.classList.remove('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
        },

        revealCorrectAnswer: function(shape) {
            const itemSize = 40;
            const gap = 35;
            const sequence = this.state.currentData.sequence;
            const totalWidth = sequence.length * itemSize + (sequence.length - 1) * gap;
            let startX = (this.canvas.width - totalWidth) / 2 + itemSize/2;
            const centerY = this.canvas.height / 2;

            // X√≥a d·∫•u h·ªèi
            // V·∫Ω ƒë√® h√¨nh ƒë√∫ng m√†u xanh
            this.ctx.fillStyle = '#22c55e';
            this.ctx.strokeStyle = '#22c55e';
            
            // T√¨m v·ªã tr√≠ blank
            const blankX = startX + this.state.currentData.blankIndex * (itemSize + gap);
            
            // X√≥a khu v·ª±c ƒë√≥ tr√™n canvas
            this.ctx.clearRect(blankX - itemSize/1.5, centerY - itemSize/1.5, itemSize*1.5, itemSize*1.5);
            
            ShapeDrawer.draw(this.ctx, shape, blankX, centerY, itemSize);
        },

        endGame: function() {
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = this.state.score;
        },

        shuffle: function(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    };

</script>
</body>
</html>