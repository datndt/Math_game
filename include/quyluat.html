<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quy Lu·∫≠t H√¨nh H·ªçc - V·∫°n Hoa T·∫©y</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f8fafc;
            user-select: none;
            padding: 20px;
        }

        h1 { color: #334155; text-align: center; font-size: 28px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }

        .game-card {
            background: white;
            max-width: 850px;
            margin: 0 auto;
            border-radius: 24px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.08);
            border: 4px solid #e2e8f0;
            padding: 25px;
            min-height: 550px;
            display: flex; flex-direction: column;
            position: relative;
            transition: border-color 0.5s;
        }

        /* --- KHU V·ª∞C ƒê·ªÄ B√ÄI --- */
        .sequence-area {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding: 30px 10px;
            background: #f1f5f9;
            border-radius: 20px;
            border: 2px dashed #cbd5e1;
            min-height: 240px;
            margin-bottom: 20px;
            transition: all 0.5s;
        }

        .step-box {
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .step-label { font-size: 14px; color: #64748b; font-weight: 800; text-transform: uppercase; }

        .arrow-next { font-size: 24px; color: #94a3b8; font-weight: bold; align-self: center; opacity: 0.5; }

        .question-box {
            width: 80px; height: 80px;
            border: 4px dashed #94a3b8; border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: #94a3b8; background: #fff;
            animation: pulse 2s infinite;
        }

        /* --- KHU V·ª∞C ƒê√ÅP √ÅN --- */
        .options-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: auto;
        }

        .option-card {
            background: white; border: 3px solid #f1f5f9; border-radius: 20px;
            padding: 20px; cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: center; align-items: center;
            min-height: 140px;
            position: relative;
            overflow: hidden;
        }
        
        .option-card:hover { border-color: #cbd5e1; background: #f8fafc; transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .option-card:active { transform: scale(0.96); }

        .correct { background: #dcfce7 !important; border-color: #22c55e !important; pointer-events: none; }
        .wrong { background: #fee2e2 !important; border-color: #ef4444 !important; opacity: 0.5; pointer-events: none; }

        /* --- CSS V·∫º H√åNH ƒê·ªòNG (GENERIC) --- */
        .shape-container { display: grid; gap: 4px; transition: all 0.5s; }
        
        /* 1. Rect Cell */
        .cell { width: 20px; height: 20px; border-radius: 4px; transition: background-color 0.5s; }

        /* 2. Line Circle */
        .line-wrapper { display: flex; align-items: center; gap: 2px; }
        .head-shape { width: 24px; height: 24px; border-radius: 6px; z-index: 2; }
        .tail-shape { width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; margin-left: -6px; }

        /* 3. L-Shape Dots */
        .dot { width: 24px; height: 24px; border-radius: 50%; box-shadow: inset -3px -3px rgba(0,0,0,0.1); }
        .dot-trans { background: transparent; }

        /* 4. Pyramid Triangles */
        .pyramid-wrapper { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .pyramid-row { display: flex; gap: 2px; }
        .tri-up { width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-bottom: 20px solid currentColor; }
        .tri-down { width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-top: 20px solid currentColor; }

        /* --- CONTROLS --- */
        .level-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .lvl-btn { padding: 10px 25px; border-radius: 30px; border: none; font-weight: 800; cursor: pointer; color: white; opacity: 0.6; transition: all 0.2s; }
        .lvl-btn.active { opacity: 1; transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .bg-easy { background: linear-gradient(135deg, #10b981, #059669); }
        .bg-med { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .bg-hard { background: linear-gradient(135deg, #ef4444, #b91c1c); }

        #msg { text-align: center; height: 30px; font-weight: 800; font-size: 22px; margin: 10px 0; }
        
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    </style>
</head>
<body>

    <h1>‚ú® V·∫°n Hoa T·∫©y Logic</h1>

    <div class="level-bar">
        <button class="lvl-btn bg-easy active" onclick="setLevel('easy', this)">D·ªÖ</button>
        <button class="lvl-btn bg-med" onclick="setLevel('medium', this)">V·ª´a</button>
        <button class="lvl-btn bg-hard" onclick="setLevel('hard', this)">Kh√≥</button>
    </div>

    <div class="game-card" id="main-card">
        <div class="sequence-area" id="sequence-container"></div>
        <div id="msg"></div>
        <div class="options-grid" id="options-container"></div>

        <div style="text-align: center; margin-top: 20px;">
            <button onclick="forceNextQuestion()" class="text-slate-400 font-bold hover:text-slate-600 transition-colors">
                B·ªè qua c√¢u n√†y ‚ûú
            </button>
        </div>
    </div>

<script>
    // --- PALETTES (B·∫£ng m√†u ƒë·ªông) ---
    const PALETTES = [
        { main: '#ec4899', sec: '#fbcfe8', border: '#fce7f3' }, // H·ªìng
        { main: '#8b5cf6', sec: '#ddd6fe', border: '#ede9fe' }, // T√≠m
        { main: '#3b82f6', sec: '#bfdbfe', border: '#dbeafe' }, // Xanh d∆∞∆°ng
        { main: '#10b981', sec: '#6ee7b7', border: '#d1fae5' }, // Xanh l√°
        { main: '#f59e0b', sec: '#fde68a', border: '#fef3c7' }, // Cam
        { main: '#ef4444', sec: '#fca5a5', border: '#fee2e2' }  // ƒê·ªè
    ];

    // --- STATE ---
    let currentLevel = 'easy';
    let currentConfig = {}; // L∆∞u c·∫•u h√¨nh c√¢u h·ªèi hi·ªán t·∫°i (lo·∫°i, m√†u, h∆∞·ªõng...)
    let lastPatternType = ''; 
    let correctAnswerValue = 0; 
    let isAnswered = false;
    let autoNextTimer = null;

    // --- GAME LOGIC ---

    function setLevel(lvl, btn) {
        currentLevel = lvl;
        document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        nextQuestion();
    }

    function nextQuestion() {
        if (autoNextTimer) { clearTimeout(autoNextTimer); autoNextTimer = null; }
        isAnswered = false;
        document.getElementById('msg').textContent = '';

        // 1. CH·ªåN M√ÄU NG·∫™U NHI√äN
        const palette = PALETTES[Math.floor(Math.random() * PALETTES.length)];
        applyTheme(palette);

        // 2. CH·ªåN LO·∫†I B√ÄI (Kh√¥ng tr√πng lo·∫°i v·ª´a ra)
        const types = ['rect', 'line', 'lshape', 'pyramid'];
        let type;
        do {
            type = types[Math.floor(Math.random() * types.length)];
        } while (type === lastPatternType && Math.random() > 0.3); // 70% c∆° h·ªôi ƒë·ªïi lo·∫°i m·ªõi
        lastPatternType = type;

        // 3. T·∫†O C·∫§U H√åNH BI·∫æN TH·ªÇ (Variation)
        // M·ªói lo·∫°i h√¨nh s·∫Ω c√≥ c√°c bi·∫øn th·ªÉ xoay/d·ªçc/ngang
        currentConfig = {
            type: type,
            colorMain: palette.main,
            colorSec: palette.sec,
            // Bi·∫øn th·ªÉ ng·∫´u nhi√™n:
            direction: Math.random() > 0.5 ? 'row' : 'col', // Cho Rect
            rotation: Math.floor(Math.random() * 4) * 90,   // Cho L-Shape (0, 90, 180, 270)
            inverted: Math.random() > 0.5,                  // Cho Pyramid
            shapeHead: Math.random() > 0.5 ? 'rect' : 'circle' // Cho Line
        };

        renderSequence();
    }

    function forceNextQuestion() { nextQuestion(); }

    function applyTheme(palette) {
        const card = document.getElementById('main-card');
        const seq = document.getElementById('sequence-container');
        
        card.style.borderColor = palette.border;
        seq.style.borderColor = palette.sec;
        seq.style.backgroundColor = palette.border; // M√†u n·ªÅn nh·∫°t
        
        // Update m√†u d·∫•u ?
        const qBox = document.querySelector('.question-box');
        if(qBox) {
            qBox.style.color = palette.main;
            qBox.style.borderColor = palette.main;
        }
    }

    function renderSequence() {
        const seqContainer = document.getElementById('sequence-container');
        seqContainer.innerHTML = '';

        let startN = (currentLevel === 'hard') ? 2 : 1;

        for(let i=0; i<3; i++) {
            let n = startN + i;
            let shapeHTML = generateShapeHTML(n, currentConfig);
            
            let box = document.createElement('div');
            box.className = 'step-box';
            box.style.animationDelay = `${i * 0.1}s`;
            box.innerHTML = `${shapeHTML}<div class="step-label" style="color:${currentConfig.colorMain}">B∆Ø·ªöC ${i+1}</div>`;
            seqContainer.appendChild(box);

            if(i < 2) seqContainer.innerHTML += `<div class="arrow-next">‚ûú</div>`;
        }
        
        seqContainer.innerHTML += `<div class="arrow-next">‚ûú</div>`;
        seqContainer.innerHTML += `
            <div class="step-box" style="animation-delay:0.3s">
                <div class="question-box" style="color:${currentConfig.colorMain}; border-color:${currentConfig.colorMain}">?</div>
                <div class="step-label" style="color:${currentConfig.colorMain}">B∆Ø·ªöC 4</div>
            </div>
        `;

        correctAnswerValue = startN + 3;
        generateOptions(correctAnswerValue);
    }

    function generateOptions(correctVal) {
        const container = document.getElementById('options-container');
        container.innerHTML = '';

        let optionsSet = new Set([correctVal]);
        while(optionsSet.size < 3) {
            let offset = (Math.random() < 0.5 ? -1 : 1) * Math.ceil(Math.random() * 2);
            let wrongVal = correctVal + offset;
            if(wrongVal > 0 && wrongVal !== correctVal) optionsSet.add(wrongVal);
        }

        let optionsArr = Array.from(optionsSet).sort(() => Math.random() - 0.5);

        optionsArr.forEach(val => {
            let btn = document.createElement('div');
            btn.className = 'option-card';
            // Khi hover, ƒë·ªïi m√†u border theo theme
            btn.onmouseenter = () => btn.style.borderColor = currentConfig.colorMain;
            btn.onmouseleave = () => { if(!btn.classList.contains('correct') && !btn.classList.contains('wrong')) btn.style.borderColor = '#f1f5f9'; };
            
            btn.innerHTML = generateShapeHTML(val, currentConfig);
            btn.onclick = () => checkAnswer(val, btn);
            container.appendChild(btn);
        });
    }

    function checkAnswer(val, btnElement) {
        if(isAnswered) return;
        isAnswered = true;

        const msg = document.getElementById('msg');

        if(val === correctAnswerValue) {
            btnElement.classList.add('correct');
            msg.innerHTML = "<span style='color:#16a34a'>Ch√≠nh x√°c! Xu·∫•t s·∫Øc! üéâ</span>";
            autoNextTimer = setTimeout(nextQuestion, 1500);
        } else {
            btnElement.classList.add('wrong');
            msg.innerHTML = "<span style='color:#ef4444'>Ch∆∞a ƒë√∫ng r·ªìi! ü§î</span>";
            autoNextTimer = setTimeout(nextQuestion, 2000); 
        }
    }

    // --- GENERATORS (V·∫Ω h√¨nh d·ª±a tr√™n Config) ---

    function generateShapeHTML(n, config) {
        if (config.type === 'rect') return drawRect(n, config);
        if (config.type === 'line') return drawLine(n, config);
        if (config.type === 'lshape') return drawL(n, config);
        if (config.type === 'pyramid') return drawPyramid(n, config);
        return '';
    }

    // 1. RECTANGLE (Bi·∫øn th·ªÉ: Ngang ho·∫∑c D·ªçc)
    function drawRect(n, config) {
        // Easy: 1 line, Medium: 2 lines, Hard: 3 lines
        let thickness = (currentLevel === 'medium') ? 2 : (currentLevel === 'hard' ? 3 : 1);
        
        let cols = (config.direction === 'row') ? n : thickness;
        let rows = (config.direction === 'row') ? thickness : n;

        let html = `<div class="shape-container" style="grid-template-columns: repeat(${cols}, 1fr);">`;
        for(let i=0; i<rows*cols; i++) {
            html += `<div class="cell" style="background-color: ${config.colorMain}"></div>`;
        }
        html += `</div>`;
        return html;
    }

    // 2. LINE (Bi·∫øn th·ªÉ: ƒê·∫ßu Tr√≤n ho·∫∑c Vu√¥ng)
    function drawLine(n, config) {
        let count = (currentLevel === 'medium') ? n+1 : (currentLevel === 'hard' ? n*2 : n);
        let borderRadius = (config.shapeHead === 'circle') ? '50%' : '4px';

        let html = `<div class="line-wrapper">`;
        html += `<div class="head-shape" style="background-color: ${config.colorMain}; border-radius:${borderRadius}"></div>`;
        
        for(let i=0; i<count; i++) {
            html += `<div class="tail-shape" style="background-color: ${config.colorSec}; border-color: ${config.colorMain}"></div>`;
        }
        html += `</div>`;
        return html;
    }

    // 3. L-SHAPE (Bi·∫øn th·ªÉ: Xoay c√°c h∆∞·ªõng)
    function drawL(n, config) {
        let size = n;
        // Xoay b·∫±ng CSS transform cho container cha
        let rotation = config.rotation;
        
        let html = `<div class="shape-container" style="grid-template-columns: repeat(${size}, 1fr); transform: rotate(${rotation}deg);">`;
        for(let r=0; r<size; r++) {
            for(let c=0; c<size; c++) {
                // Logic v·∫Ω ch·ªØ L m·∫∑c ƒë·ªãnh (G√≥c tr√°i d∆∞·ªõi)
                let isCorner = (r === size-1 && c === 0);
                let isSide = (c === 0 && r < size-1) || (r === size-1 && c > 0);
                
                if (isCorner) html += `<div class="dot" style="background-color: ${config.colorMain}"></div>`;
                else if (isSide) html += `<div class="dot" style="background-color: ${config.colorSec}"></div>`;
                else html += `<div class="dot dot-trans"></div>`;
            }
        }
        html += `</div>`;
        return html;
    }

    // 4. PYRAMID (Bi·∫øn th·ªÉ: Xu√¥i ho·∫∑c Ng∆∞·ª£c)
    function drawPyramid(n, config) {
        let directionClass = config.inverted ? 'tri-down' : 'tri-up';
        // Flex column-reverse n·∫øu l√† inverted ƒë·ªÉ x√¢y t·ª´ ƒë√°y l√™n (ho·∫∑c ng∆∞·ª£c l·∫°i)
        let flexDir = config.inverted ? 'column-reverse' : 'column';

        let html = `<div class="pyramid-wrapper" style="flex-direction:${flexDir}">`;
        for(let r=1; r<=n; r++) {
            html += `<div class="pyramid-row">`;
            for(let c=0; c<r; c++) {
                html += `<div class="${directionClass}" style="color: ${config.colorMain}"></div>`;
            }
            html += `</div>`;
        }
        html += `</div>`;
        return html;
    }

    // Start
    nextQuestion();

</script>
</body>
</html>